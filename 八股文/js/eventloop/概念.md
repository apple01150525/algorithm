# eventloop

## 进程和线程

### 进程
- cpu承担了所有的计算任务
- 进程是cpu分配资源的最小单位
- 在同一个时间内，单个cpu只能执行一个任务，只能运行一个进程
- 如果有一个进程在执行，其他的进程就得暂停
- cpu使用了事件片轮转的算法实现多进程的调度

### 线程
- 线程是cpu调度的最小单位
- 一个进程可以包括多个线程，折现线程共享这个进程的资源


## chrome 浏览器进程

- 浏览器是多进程的
- 每一个tab页就是一个进程
- 浏览器的主进程
    - 控制其他子进程的创建和销毁
    - 浏览器的界面显示
- 渲染进程就是我们说的浏览器内核

## 渲染进程

### GUI渲染线程
- 渲染、布局和绘制页面
- 当页面需要重绘和回流时，此线程就会执行
- 与js引擎互斥

### js引擎线程
- 负责解析执行js脚本
- 只有一个js引擎线程（单线程）
- 与GUI渲染线程互斥

### 事件触发线程
- 用来控制事件循环（鼠标点击、setTimeout、Ajax等）
- 当事件满足触发条件的时候，把事件放入到js引擎所有的执行队列中

### 定时器触发线程
- setInterval 和setTimeout所在线程
- 定时任务并不是由js引擎计时，而是由定时触发线程来计时的
- 计时完成后会通知事件触发线程

### 异步http请求线程
- 浏览器有一个单独的线程处理AJAX请求
- 请求完毕后， 如果由回调函数，会通知事件触发线程

## 宏任务和微任务

### 宏任务
- 页面上大部分任务都是宏任务，比如
    - 渲染事件（dom解析、布局、绘制）
    - 用户交互（鼠标点击、页面缩放）
    - 网络请求
    - js脚本执行
    - 文件读写
- 宏任务会添加消息到消息队列的尾部，挡住线程执行到概消息时就会执行
- 每次从事件队列中获取一个事件回调并且方法哦执行栈中的就是一个宏任务，宏任务执行过程中不会执行其他内容
- 每次宏任务执行完毕后会进行GUI渲染线程的渲染，然后在执行下一个宏任务
- 宏任务： script（整体代码）setTimeout、setInterval、setImmediate、I/O、UIrendering、ajax、evebt
- 宏任务粒度较大，不适合需要精确控制环境的任务
- 宏任务是由宿主方控制的

### 微任务
- 宏任务结束后会进行渲染然后执行下一个宏任务
- 微任务是当前宏任务执行后立即执行, 在渲染前先执行微任务
- 当宏任务执行完，就到达检查点，会先执行期间产生的所有微任务，都执行完再去进行渲染
- 微任务是由v8引擎控制的，在创建全局执行上下文的时候，也会在v8引擎的内部创建一个微任务队列
- 微任务： process.nextTick(nodejs), Promise, Object.observe, MutationObserve

### 执行顺序

先执行宏任务，在执行微任务，宏任务每次执行一个，微任务全部执行
